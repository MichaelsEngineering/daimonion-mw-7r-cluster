name: provenance

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-attest:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.11"

      - name: Build artifact
        run: |
          python -m mwpack build \
            --memo docs/memo_template.md \
            --config tools/example_5mw_config.json \
            --out dist/provenance \
            --source-date-epoch 1700000000

      - name: Package artifact
        run: |
          python -m mwpack package \
            --dir dist/provenance \
            --format zip \
            --source-date-epoch 1700000000

      - name: Attest build provenance
        uses: actions/attest-build-provenance@a2bbfa25375fe432b6a289bc6b6cd05ecd0c4c32 # v1.4.0
        with:
          subject-path: dist/provenance/bundle.zip
